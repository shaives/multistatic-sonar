<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BISON - BI-static Sonar OptimizatioN</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Libre Franklin', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f5f7;
        }
        #title {
            padding: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            width: 100%;
        }
        #title .highlight {
            color: #ff8c00;
        }
        #map-container {
            width: 100%;
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #coordinates-container {
            width: 200px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #coordinates {
            width: 100%;
            margin-bottom: 10px;
        }
        #download-btn {
            position: fixed;
            bottom: 20px;
            padding: 10px 20px;
            background-color: #ff8c00;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Libre Franklin', sans-serif;
            font-weight: 700;
            z-index: 1000;
        }
        #download-btn:hover {
            background-color: #e67e00;
        }
        .leaflet-control {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        .leaflet-control label {
            width: 200px;
            display: block;
            margin-bottom: 5px;
        }
        .leaflet-control input[type="radio"] {
            margin-right: 5px;
        }
        .leaflet-control input[type="number"] {
            width: 95%;
            margin-top: 2px;
            margin-bottom: 10px;
            font-family: 'Libre Franklin', sans-serif;
            padding: 5px;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
        }
        .control-title {
            font-weight: 700;
            margin-bottom: 10px;
        }
        .value-input-container {
            width: 100%;
        }
        #coordinateInputs {
            display: none;
            margin-top: 10px;
        }
        #coordinateInputs input {
            width: 95%;
            margin-bottom: 5px;
        }
        #coordinateInputs button {
            margin-top: 5px;
            padding: 5px;
            width: 100%;
            background-color: #ff8c00;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #coordinateInputs button:hover {
            background-color: #e67e00;
        }
        .info-panel {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            width: 200px;  /* Match the width of other controls */
        }
        .info-panel h4 {
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 14px;
        }
        /* Add this to ensure consistent spacing */
        .info-panel p {
            margin: 5px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="title" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: white; padding: 5px 10px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); z-index: 1000; width: 444px;">
        BISON - <span class="highlight">BI</span>-static <span class="highlight">S</span>onar <span class="highlight">O</span>ptimizatio<span class="highlight">N</span>
    </div>
    <div id="map-container">
        <div id="map"></div>
    </div>
    <button id="download-btn">Download Selection</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script>
        // Initialize the map
        var map = L.map('map').setView([0, 0], 3);

        // Add OpenStreetMap tile layer as the base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add OpenSeaMap nautical layer
        L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="http://www.openseamap.org">OpenSeaMap</a> contributors'
        }).addTo(map);

        var rectangle;
        var isDrawing = false;
        var startCorner;

        // Custom control for optimization type selection
        L.Control.OptimizationType = L.Control.extend({
            onAdd: function(map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                container.innerHTML = `
                    <div class="control-title">Optimization Type:</div>
                    <label>
                        <input type="radio" name="optimizationType" value="coverage" checked>
                        Coverage
                    </label>
                    <label>
                        <input type="radio" name="optimizationType" value="cost">
                        Cost
                    </label>
                `;
                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });

        // Custom control for size selection
        L.Control.SizeSelector = L.Control.extend({
            onAdd: function(map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                container.innerHTML = `
                    <div class="control-title">Square Size:</div>
                    <label>
                        <input type="radio" name="squareSize" value="10" checked>
                        10x10 NM
                    </label>
                    <label>
                        <input type="radio" name="squareSize" value="30">
                        30x30 NM
                    </label>
                    <label>
                        <input type="radio" name="squareSize" value="100">
                        100x100 NM
                    </label>
                    <label>
                        <input type="radio" name="squareSize" value="custom">
                        Custom Size
                    </label>
                    <label>
                        <input type="radio" name="squareSize" value="coordinates">
                        Enter Coordinates
                    </label>
                    <div id="coordinateInputs">
                        <label for="nwLat">NW Latitude:</label>
                        <input type="number" id="nwLat" step="0.000001">
                        <label for="nwLon">NW Longitude:</label>
                        <input type="number" id="nwLon" step="0.000001">
                        <label for="seLat">SE Latitude:</label>
                        <input type="number" id="seLat" step="0.000001">
                        <label for="seLon">SE Longitude:</label>
                        <input type="number" id="seLon" step="0.000001"><br/>
                        <button id="applyCoordinates">Apply Coordinates</button>
                    </div>
                `;
                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });

        // Custom control for entering values
        L.Control.ValueInput = L.Control.extend({
            onAdd: function(map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                container.innerHTML = `
                    <div class="control-title">Enter Values:</div>
                    <div class="value-input-container">
                        <div id="coverageInputs">
                            <label for="senderCount"># of Sender Buoys:</label>
                            <input type="number" id="senderCount" min="0" step="1">
                            <label for="receiverCount"># of Receiver Buoys:</label>
                            <input type="number" id="receiverCount" min="0" step="1">
                        </div>
                        <div id="costInputs" style="display:none;">
                            <label for="senderCost">Sender Buoy Cost:</label>
                            <input type="number" id="senderCost" min="0" step="0.01">
                            <label for="receiverCost">Receiver Buoy Cost:</label>
                            <input type="number" id="receiverCost" min="0" step="0.01">
                        </div>
                    </div>
                `;
                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });

        // Custom control for info display
        L.Control.InfoPanel = L.Control.extend({
            onAdd: function(map) {
                this._div = L.DomUtil.create('div', 'leaflet-bar leaflet-control info-panel');
                this.update();
                return this._div;
            },

            update: function(data) {
                if (!data) {
                    this._div.innerHTML = '<div class="control-title">Selection Info</div>Select an area on the map';
                    return;
                }
                this._div.innerHTML = data;
            }
        });

        // Add the info panel control to the map
        var infoPanel = new L.Control.InfoPanel({ position: 'bottomleft' }).addTo(map);

        // Add the custom controls to the map
        new L.Control.OptimizationType({ position: 'topright' }).addTo(map);
        new L.Control.ValueInput({ position: 'topright' }).addTo(map);
        new L.Control.SizeSelector({ position: 'topright' }).addTo(map);
        
        // Function to create a square or rectangle
        function createRectangle(bounds) {
            if (rectangle) {
                map.removeLayer(rectangle);
            }
            rectangle = L.rectangle(bounds, {
                color: "#ff8c00",
                weight: 2,
                fillOpacity: 0.3
            }).addTo(map);

            displayCoordinates(bounds);
        }

        function displayCoordinates(bounds) {
            var nw = [bounds.getNorth(), bounds.getWest()];
            var se = [bounds.getSouth(), bounds.getEast()];
            var coordString = 'NW: [' + nw[0].toFixed(6) + ', ' + nw[1].toFixed(6) + ']<br>' +
                            'SE: [' + se[0].toFixed(6) + ', ' + se[1].toFixed(6) + ']';
            
            var optimizationType = document.querySelector('input[name="optimizationType"]:checked').value;
            var optimizationInfo = '';
            
            if (optimizationType === 'cost') {
                var senderCost = document.getElementById('senderCost').value || '0';
                var receiverCost = document.getElementById('receiverCost').value || '0';
                optimizationInfo = '<strong>Sender Buoy Cost:</strong> ' + senderCost + '<br><strong>Receiver Buoy Cost:</strong> ' + receiverCost;
            } else {
                var senderCount = document.getElementById('senderCount').value || '0';
                var receiverCount = document.getElementById('receiverCount').value || '0';
                optimizationInfo = '<strong># of Sender Buoys:</strong> ' + senderCount + '<br><strong># of Receiver Buoys:</strong> ' + receiverCount;
            }
            
            var content = '<div class="control-title">Selection Info</div>' +
                        '<div><strong>Optimization Type:</strong> ' + optimizationType + '</div>' +
                        '<div>' + optimizationInfo + '</div>' +
                        '<div><strong>Corner Coordinates:</strong></div>' +
                        '<div>' + coordString + '</div>';
            
            infoPanel.update(content);
        }

        // Event handlers for all inputs
        ['senderCount', 'receiverCount', 'senderCost', 'receiverCost'].forEach(function(id) {
            document.getElementById(id).addEventListener('input', function() {
                if (rectangle) {
                    displayCoordinates(rectangle.getBounds());
                }
            });
        });

        // Update event handlers to use the info panel
        document.addEventListener('change', function(e) {
            if (e.target.name === 'optimizationType') {
                document.getElementById('coverageInputs').style.display = 
                    e.target.value === 'coverage' ? 'block' : 'none';
                document.getElementById('costInputs').style.display = 
                    e.target.value === 'cost' ? 'block' : 'none';
                if (rectangle) {
                    displayCoordinates(rectangle.getBounds());
                }
            } else if (e.target.name === 'squareSize') {
                document.getElementById('coordinateInputs').style.display = 
                    e.target.value === 'coordinates' ? 'block' : 'none';
            }
        });

        // Event handler for apply coordinates button
        document.getElementById('applyCoordinates').addEventListener('click', function() {
            var nwLat = parseFloat(document.getElementById('nwLat').value);
            var nwLon = parseFloat(document.getElementById('nwLon').value);
            var seLat = parseFloat(document.getElementById('seLat').value);
            var seLon = parseFloat(document.getElementById('seLon').value);

            if (isNaN(nwLat) || isNaN(nwLon) || isNaN(seLat) || isNaN(seLon)) {
                alert('Please enter valid coordinates.');
                return;
            }

            var bounds = L.latLngBounds(
                [nwLat, nwLon],
                [seLat, seLon]
            );
            createRectangle(bounds);
            map.fitBounds(bounds);
        });

        // Event handler for map click
        map.on('click', function(e) {
            var sizeOption = document.querySelector('input[name="squareSize"]:checked').value;
            if (sizeOption === 'coordinates') {
                return; // Don't do anything if in coordinate input mode
            }
            if (sizeOption === 'custom') {
                if (!isDrawing) {
                    isDrawing = true;
                    startCorner = e.latlng;
                } else {
                    isDrawing = false;
                    createRectangle(L.latLngBounds(startCorner, e.latlng));
                }
            } else {
                var size = parseInt(sizeOption);
                var degreeOffset = size / 120;
                var bounds = L.latLngBounds(
                    [e.latlng.lat - degreeOffset, e.latlng.lng - degreeOffset],
                    [e.latlng.lat + degreeOffset, e.latlng.lng + degreeOffset]
                );
                createRectangle(bounds);
            }
        });

        // Event handler for mouse move (for custom size)
        map.on('mousemove', function(e) {
            var sizeOption = document.querySelector('input[name="squareSize"]:checked').value;
            if (sizeOption === 'custom' && isDrawing) {
                createRectangle(L.latLngBounds(startCorner, e.latlng));
            }
        });

        // Function to download selection
        function downloadSelection() {
            if (!rectangle) {
                alert("Please select an area on the map first.");
                return;
            }

            var bounds = rectangle.getBounds();
            var nw = [bounds.getNorth(), bounds.getWest()];
            var se = [bounds.getSouth(), bounds.getEast()];

            var optimizationType = document.querySelector('input[name="optimizationType"]:checked').value;
            var squareSize = document.querySelector('input[name="squareSize"]:checked').value;

            var timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            var content = "BISON - BI-static Sonar OptimizatioN\n\n";
            content += "OptimizationType = " + optimizationType + "\n";
            content += "SquareSize = " + squareSize + "\n\n";
            content += "Corner Coordinates:\n";
            content += "NW = [" + nw[0].toFixed(6) + ", " + nw[1].toFixed(6) + "]\n";
            content += "SE = [" + se[0].toFixed(6) + ", " + se[1].toFixed(6) + "]\n\n";

            if (optimizationType === 'cost') {
                content += "S = " + document.getElementById('senderCost').value + "\n";
                content += "R = " + document.getElementById('receiverCost').value + "\n";
            } else {
                content += "S = " + document.getElementById('senderCount').value + "\n";
                content += "R = " + document.getElementById('receiverCount').value + "\n";
            }

            var blob = new Blob([content], { type: 'text/plain' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'bison_selection_' + timestamp + '.txt';
            link.click();
        }

        // Add event listener to download button
        document.getElementById('download-btn').addEventListener('click', downloadSelection);
    </script>
</body>
</html>